

<?php
	require_once '../models/config.php';
	require_once 'classes/db_combo.class.php';
	require_once 'classes/time.class.php';
	require_once 'classes/notice.class.php';
	$cp_no = $loggedInUser->cpnomber;

	//echo "<pre>";
	//print_r ($loggedInUser);
	
	$db_date = new DateTime($loggedInUser->eom);
    $my_details = unserialize($_SESSION['my_details']);		
	$eom = $my_details->eom;
	$supervisors = $my_details->position->command_chain;
	$post_id = $my_details->position->post_id;	
	$db_combo = new db_combo();
	$reason_id = NULL;
	$position=NULL;
	$approver_post_id = NULL;
	$eeom_date = NULL;
	$note = NULL;
	$row = 0;
	$day=$month=$year=NULL;
	$_tm= new _time();
	$notice = new notice();
	
	
	if(isset($_REQUEST['d']))
		$eeom_date = trim($_REQUEST['d']);
	
	if(isset($_REQUEST['r']))
		$reason_id = trim($_REQUEST['r']);
	
	if(isset($_REQUEST['a']))
		$approver_post_id = trim($_REQUEST['a']);
	
	if(isset($_REQUEST['n']))
			$note = trim($_REQUEST['n']);
		
	if(strlen($eeom_date) > 4 ){
		
		//print_r ($_REQUEST);
		$conn = new db_rows();
		$notice_token = time(). rand(10000, 99999);
		$row = $conn->insert_row('eeom_request', array( array('applicant_cp_no', $cp_no),
														array('eeom_date', $eeom_date),
														array('reason_id', $reason_id),
														array('applicant_note', $note),
														array('approver_post_id', $approver_post_id),
														array('status', 'Submitted'),
														array('status_date', date("Y-m-d")),
														array('notice_token', $notice_token)
													  )
									);
									
		if ($row == 1){
			$notice->sender_cp_no=$cp_no;
			$notice->sender_post_id=$post_id;
			$notice->notice_title= "Application For Early Check-Out: $cp_no";
			$notice->notice_status="New";
			$notice->notice_action_page = "sup_view_eeom";
			$notice->notice_token = $notice_token;
			$notice->recipient_post_id=$approver_post_id;
			$notice->addPositionNotice();			
			
			foreach($supervisors as $supervisor){
				$notice->recipient_post_id=$supervisor[0];
				$notice->addPositionNotice();				
			}


		}
													  
	}
	$m= date("m", strtotime($eom));
	//echo "<pre>";
	//print_r($my_details);
	$eeom = $_tm->date_box(
							   array('eeom_day', date("d"), 31, date("d")), 
							   array('eeom_month', date("m"), date("m", strtotime($eom)), date("m")),
							   array('eeom_year', date("Y"), date("Y", strtotime($eom)), date("Y"))
							);
								
	//echo $m;	
	$interface="
					  <table>
						<tr>
							<th>Proposed EOM Date</th>
							<th>Reason for Early Check-Out</th>
							<th>Approving Officer</th>
							<th>Additional Details</th>
							
						</tr>
						<tr>
							<td>$eeom</td>
							<td>".$db_combo->combo('eeom_request_reasons', 'reason', 'id', 'id="reason"', 'id > 0', '', 'Select reason from list', $reason_id)."</td>
							<td>".$db_combo->combo('positions', 'post_name', 'post_id', 'id="approver"', 'keypost = 2', '', '---[Select approver from list]--' )."</td>
							<td><textarea id=\"note\" cols=\"40\" rows=\"3\" id=\"note\">$note</textarea></td>
							
						</tr>
						<tr>
							<td colspan=\"4\"><button  onclick=\"new_eeom('save')\">Submit</button><button onclick=\"new_eeom('Cancel')\">Cancel</button></td>
							
								
						</tr>
					</table> "; 
					
					
				
				
	echo $interface;			
	
	function send_notice(){
		
	}
?>