<?php 
	require_once '../models/config.php';
	require_once 'classes/notice.class.php';
	require_once 'classes/placement.class.php';
	require_once 'classes/tokenizer.class.php';
	if(!isset($loggedInUser)) header('../login.php');
	$my_cp_no = $loggedInUser->cpnomber;
	$my_details = unserialize($_SESSION['my_details']);	
	$my_post_id = $my_details->position->post_id;
	$tokenizer = new tokenizer();
	$notice_token = $tokenizer->tokenize();
	$position = new position();
	
//	$db_date = new DateTime($loggedInUser->eom);	
//	$e = strtotime($loggedInUser->eom);	
//	$eom = "$e";

	$reason_id = NULL;
	$my_position=NULL;
	$approver_post_id = NULL;
	$repatriant_cp_no=NULL;
	$repatriant_post_id = NULL;
	$eeom_date = NULL;
	$eom = NULL;
	$note = NULL;
	$row = 0;
	$day=$month=$year=NULL;
	$notice = new notice();
	
	
	if(isset($_REQUEST['d']))
		$eeom_date = trim($_REQUEST['d']);
	
	if(isset($_REQUEST['r']))
		$reason_id = trim($_REQUEST['r']);
	
	if(isset($_REQUEST['a']))
		$approver_post_id = trim($_REQUEST['a']);
	
	if(isset($_REQUEST['n']))
			$note = trim($_REQUEST['n']);
	
	if(isset($_REQUEST['k']))
			$index = trim($_REQUEST['k']);
		
	if(isset($_REQUEST['c']))
			$repatriant_cp_no = trim(decrypt($_REQUEST['c']));
		
		if(isset($_REQUEST['pi']))
			$repatriant_post_id = trim(decrypt($_REQUEST['pi']));
		
	if(strlen($eeom_date) > 4 ){
		
		//print_r ($_REQUEST);
		$conn = new db_rows();
		 
		$row = $conn->insert_row('repatriation_request', array( array('applicant_cp_no', $my_cp_no),
														array('applicant_post_id', $my_post_id),
														array('eeom_date', $eeom_date),
														array('reason_id', $reason_id),
														array('applicant_note', $note),
														array('repatriant_cp_no', $repatriant_cp_no),
														array('repatriant_post_id', $repatriant_post_id),
														array('approver_post_id', $approver_post_id),
														array('status', 'Submitted'),
														array('status_date', date("Y-m-d")),
														array('notice_token', $notice_token)
													  )
									);
									
		if ($row == 1){
			$repatriant_supervisors = array();
			$position->getPosition($repatriant_post_id);
			$repatriant_supervisors = $position->command_chain;
			$notice->sender_cp_no= $my_cp_no;
			$notice->sender_post_id= $my_post_id;	
			$notice->notice_title= "Request For Repatriation: $repatriant_cp_no";	
			$notice->notice_status="New";	
			$notice->notice_action_page = "sup_view_repatriation";	
			$notice->notice_token = $notice_token;	
			$notice->recipient_post_id=$approver_post_id;
			
			foreach($repatriant_supervisors as $supervisor){				
				$notice->recipient_post_id=$supervisor[0];
				$notice->addPositionNotice();			 
			}
			
			$notice->recipient_post_id=$approver_post_id;
			$notice->addPositionNotice();
			echo "Record submitted";
	
		}
													  
	}
	
?>